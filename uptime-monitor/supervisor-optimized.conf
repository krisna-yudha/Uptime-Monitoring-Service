# Supervisor Configuration - Optimized for Fast Response & Auto-Cleanup
# Installation:
# sudo cp supervisor-optimized.conf /etc/supervisor/conf.d/uptime-monitor.conf
# sudo supervisorctl reread && sudo supervisorctl update && sudo supervisorctl start uptime-monitor:*

# Laravel Scheduler - runs all scheduled tasks (see routes/console.php)
# Handles: monitor:check, metrics:aggregate, queue:monitor-health, cleanup, dll
[program:uptime-scheduler]
command=php /var/www/uptime-monitor/artisan schedule:work
directory=/var/www/uptime-monitor
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/www/uptime-monitor/storage/logs/scheduler.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stopwaitsecs=15
startsecs=5
priority=1001

# Priority Queue Worker - untuk monitor baru (multiple processes, sleep 1s)
[program:uptime-priority-queue]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/uptime-monitor/artisan queue:work database --queue=monitor-checks-priority --tries=3 --timeout=300 --sleep=1 --verbose
directory=/var/www/uptime-monitor
user=www-data
numprocs=2
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
redirect_stderr=true
stdout_logfile=/var/www/uptime-monitor/storage/logs/worker-priority.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stopwaitsecs=60
startsecs=5
priority=1000

# Regular Queue Worker - untuk monitor existing (sleep 3s)
[program:uptime-regular-queue]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/uptime-monitor/artisan queue:work database --queue=monitor-checks --tries=3 --timeout=300 --sleep=3 --verbose
directory=/var/www/uptime-monitor
user=www-data
numprocs=4
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
redirect_stderr=true
stdout_logfile=/var/www/uptime-monitor/storage/logs/worker-regular.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stopwaitsecs=60
startsecs=5
priority=999

# Notification Worker
[program:uptime-notifications]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/uptime-monitor/artisan worker:notifications --verbose
directory=/var/www/uptime-monitor
user=www-data
numprocs=1
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
redirect_stderr=true
stdout_logfile=/var/www/uptime-monitor/storage/logs/worker-notifications.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stopwaitsecs=60
startsecs=5
priority=998

# NOTE: Queue health, cleanup, dan monitoring tasks sudah dihandle oleh Laravel Scheduler
# Lihat routes/console.php untuk daftar scheduled tasks

# Group all programs for easy management
[group:uptime-monitor]
programs=uptime-scheduler,uptime-priority-queue,uptime-regular-queue,uptime-notifications

# Management commands:
# sudo supervisorctl status uptime-monitor:*
# sudo supervisorctl start uptime-monitor:*
# sudo supervisorctl stop uptime-monitor:*
# sudo supervisorctl restart uptime-monitor:*
# sudo supervisorctl tail -f uptime-monitor:uptime-scheduler stdout
# sudo supervisorctl tail -f uptime-monitor:uptime-priority-queue_00 stdout
#
# Scheduled tasks (via Laravel Scheduler - see routes/console.php):
# - monitor:check              -> every 10 seconds
# - metrics:aggregate          -> minute/hour/day
# - queue:monitor-health       -> every 5 minutes  
# - queue:cleanup              -> every 5 minutes
# - queue:monitor-health --cleanup -> hourly
# - metrics:cleanup            -> daily 2am
# - logs:cleanup               -> monthly
