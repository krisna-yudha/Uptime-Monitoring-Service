# Supervisor Configuration for Uptime Monitor - Notification Worker Only
# Copy this file to: /etc/supervisor/conf.d/uptime-notification-worker.conf
# 
# This configuration runs the notification queue worker that sends alerts
# to Discord, Telegram, Slack, and other notification channels when incidents occur.
#
# Installation Steps:
# ===================
# 1. Copy file to supervisor directory:
#    sudo cp supervisor-notification-worker.conf /etc/supervisor/conf.d/uptime-notification-worker.conf
#
# 2. Edit the paths below to match your server installation:
#    - command: Update /var/www/uptime-monitor to your actual path
#    - user: Change www-data if using different user
#    - stdout_logfile: Update log path if needed
#
# 3. Reload and start supervisor:
#    sudo supervisorctl reread
#    sudo supervisorctl update
#    sudo supervisorctl start uptime-notification-worker:*
#
# 4. Check status:
#    sudo supervisorctl status uptime-notification-worker:*
#
# 5. View logs:
#    sudo tail -f /var/www/uptime-monitor/storage/logs/worker-notifications.log
#
# Management Commands:
# ====================
# Start:   sudo supervisorctl start uptime-notification-worker:*
# Stop:    sudo supervisorctl stop uptime-notification-worker:*
# Restart: sudo supervisorctl restart uptime-notification-worker:*
# Status:  sudo supervisorctl status uptime-notification-worker:*
# Logs:    sudo supervisorctl tail -f uptime-notification-worker:uptime-notification-worker_00

[program:uptime-notification-worker]
# Process naming - allows running multiple instances
process_name=%(program_name)s_%(process_num)02d

# Command to run - notification queue worker
# IMPORTANT: Update /var/www/uptime-monitor to match your installation path
command=php /var/www/uptime-monitor/artisan queue:work database --queue=notifications --sleep=0 --tries=3 --timeout=120 --max-jobs=1000 --name=notification-worker

# Auto-start on system boot
autostart=true

# Auto-restart if worker crashes or stops
autorestart=true

# Gracefully stop all child processes when stopping
stopasgroup=true
killasgroup=true

# User to run the worker process as
# IMPORTANT: Change to your web server user (www-data, nginx, apache, etc.)
user=www-data

# Number of worker processes to run
# 1 is usually sufficient for notifications, increase if high volume
numprocs=1

# Redirect stderr to stdout
redirect_stderr=true

# Log file location
# IMPORTANT: Ensure storage/logs directory is writable by the user
stdout_logfile=/var/www/uptime-monitor/storage/logs/worker-notifications.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5

# How long to wait for graceful shutdown before killing (seconds)
# Increased to allow notifications to finish sending
stopwaitsecs=60

# Minimum uptime before considering the process successfully started
startsecs=3

# Priority (lower number = higher priority)
# Set lower priority than monitor checks (which should be 999)
priority=998

# Environment variables (optional)
# Uncomment and set if needed
# environment=LARAVEL_ENV="production"

# Working directory (optional)
# directory=/var/www/uptime-monitor

# Restart policy
# Restart if worker exits with non-zero code
autorestart=unexpected

# Number of seconds to wait before retrying restart
startretries=3
