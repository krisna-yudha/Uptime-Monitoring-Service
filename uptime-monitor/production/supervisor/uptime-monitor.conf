# ============================================================================
# OPTIMIZED CONFIGURATION - Fast Response & Auto-Cleanup
# ============================================================================
# Features:
# - Laravel Scheduler (runs all scheduled tasks from console.php)
# - Priority queue worker for new monitors (fast response 2-5s)
# - Regular queue worker for existing monitors
# - Notification worker for alerts
# 
# Scheduled tasks (via Laravel Scheduler):
# - monitor:check every 10 seconds
# - metrics:aggregate (minute/hour/day)
# - queue:monitor-health every 5 minutes
# - queue:cleanup every 5 minutes
# - queue:monitor-health --cleanup hourly
# ============================================================================

# Laravel Scheduler - runs all scheduled tasks (see routes/console.php)
[program:uptime-scheduler]
command=php /var/www/uptime-monitor/artisan schedule:work
directory=/var/www/uptime-monitor
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/uptime-scheduler.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stopwaitsecs=15
startsecs=5
priority=1001

# Priority Queue Worker - untuk monitor BARU (sleep=0 for instant response)
[program:uptime-priority-queue]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/uptime-monitor/artisan queue:work redis --queue=monitor-checks-priority --sleep=0 --tries=3 --timeout=300 --max-jobs=1000 --verbose
directory=/var/www/uptime-monitor
user=www-data
numprocs=2
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/uptime-priority-queue.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stopwaitsecs=60
startsecs=5
priority=1000

# Regular Queue Worker - untuk monitor EXISTING (sleep=1 for efficiency)
[program:uptime-regular-queue]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/uptime-monitor/artisan queue:work redis --queue=monitor-checks,default --sleep=1 --tries=3 --timeout=300 --max-jobs=1000 --verbose
directory=/var/www/uptime-monitor
user=www-data
numprocs=4
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/uptime-regular-queue.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stopwaitsecs=60
startsecs=5
priority=999

# Notification Worker - untuk notifications (high priority)
[program:uptime-notification-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/uptime-monitor/artisan queue:work redis --queue=notifications,high-priority --sleep=0 --tries=3 --timeout=120 --max-jobs=1000 --verbose
directory=/var/www/uptime-monitor
user=www-data
numprocs=2
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/uptime-notification-worker.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stopwaitsecs=60
startsecs=5
priority=998

# NOTE: Queue health monitoring & cleanup sudah dihandle oleh Laravel Scheduler
# Lihat routes/console.php:
# - queue:monitor-health -> every 5 minutes
# - queue:monitor-health --cleanup -> hourly
# - queue:cleanup -> every 5 minutes
# Jadi tidak perlu program terpisah di supervisor

# Group all programs for easy management
[group:uptime-monitor]
programs=uptime-scheduler,uptime-priority-queue,uptime-regular-queue,uptime-notification-worker

# ============================================================================
# MANAGEMENT COMMANDS:
# ============================================================================
# Status & Control:
#   sudo supervisorctl status uptime-monitor:*
#   sudo supervisorctl start uptime-monitor:*
#   sudo supervisorctl stop uptime-monitor:*
#   sudo supervisorctl restart uptime-monitor:*
#
# View Logs:
#   sudo supervisorctl tail -f uptime-monitor:uptime-scheduler stdout
#   sudo supervisorctl tail -f uptime-monitor:uptime-priority-queue_00 stdout
#   sudo tail -f /var/log/supervisor/uptime-scheduler.log
#   sudo tail -f /var/log/supervisor/uptime-priority-queue.log
#
# Scheduled Tasks (lihat routes/console.php):
#   - monitor:check              -> every 10 seconds
#   - metrics:aggregate          -> minute/hour/day
#   - queue:monitor-health       -> every 5 minutes
#   - queue:cleanup              -> every 5 minutes
#   - queue:monitor-health --cleanup -> hourly
#   - metrics:cleanup            -> daily 2am
#   - logs:cleanup               -> monthly
# ============================================================================
